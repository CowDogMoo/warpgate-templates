# yaml-language-server: $schema=https://raw.githubusercontent.com/cowdogmoo/warpgate/main/schema/warpgate-template.json
metadata:
    name: asdf
    version: 1.0.0
    description: A minimal container image template with [asdf](https://asdf-vm.com/) version manager for managing multiple runtime versions
    author: Jayson Grace <jayson.e.grace@gmail.com>
    license: MIT
    tags: []
    requires:
        warpgate: '>=1.0.0'
name: asdf
version: latest
base:
    image: ubuntu:24.04
    pull: true
    privileged: true
    volumes:
        /sys/fs/cgroup: /sys/fs/cgroup:rw
    run_command:
        - -d
        - -i
        - -t
        - --cgroupns=host
        - '{{ .Image }}'
    environment:
        DEBIAN_FRONTEND: noninteractive
        TZ: UTC
    changes:
        - ENTRYPOINT ${ENTRYPOINT}
        - ENV ASDF_DIR=/home/asdf/.asdf
        - ENV ASDF_DATA_DIR=/home/asdf/.asdf
        - ENV PATH=/home/asdf/.asdf/shims:/home/asdf/.asdf/bin:$PATH
        - ENV DEBIAN_FRONTEND=noninteractive
        - ENV TZ=UTC
provisioners:
    - type: shell
      only:
        - docker.arm64
        - docker.amd64
      inline:
        - rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock* || true
        - apt-get update
        - apt-get install -y --no-install-recommends python3 python3-pip git sudo
        - python3 -m pip install --break-system-packages ansible-core
    - type: ansible
      only:
        - docker.arm64
        - docker.amd64
      playbook_path: ${PROVISION_REPO_PATH}/playbooks/asdf/asdf.yml
      galaxy_file: ${PROVISION_REPO_PATH}/requirements.yml
      extra_vars:
        ansible_shell_executable: /bin/bash
        asdf_cleanup: "true"
      ansible_env_vars:
        - ANSIBLE_REMOTE_TMP=/tmp/ansible-tmp-$USER
        - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - type: shell
      only:
        - docker.arm64
        - docker.amd64
      inline:
        - /tmp/post_ansible_cleanup.sh
    - type: shell
      only:
        - docker.arm64
        - docker.amd64
      inline:
        - echo "Build completed successfully"
      changes:
        - USER asdf
        - WORKDIR /workspace
targets:
    - type: container
      platforms:
        - linux/amd64
        - linux/arm64
    - type: ami
      ami_name: asdf-{{timestamp}}
      region: us-east-1
      instance_type: t3.micro
      volume_size: 50
