name: Validate Templates

on:
  push:
    branches: [main, develop]
    paths:
      - 'templates/**'
      - '.github/workflows/validate-templates.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'templates/**'
      - '.github/workflows/validate-templates.yml'

jobs:
  validate:
    name: Validate Template Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install Warpgate
        run: |
          git clone https://github.com/cowdogmoo/warpgate.git /tmp/warpgate
          cd /tmp/warpgate
          go build -o /usr/local/bin/warpgate ./cmd/warpgate
          warpgate version

      - name: Find all templates
        id: find-templates
        run: |
          templates=$(find templates -name 'warpgate.yaml' -type f)
          echo "Found templates:"
          echo "$templates"
          echo "templates<<EOF" >> $GITHUB_OUTPUT
          echo "$templates" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate templates
        run: |
          failed=0
          while IFS= read -r template; do
            if [ -n "$template" ]; then
              echo "::group::Validating $template"
              if warpgate validate "$template"; then
                echo "✓ $template is valid"
              else
                echo "✗ $template validation failed"
                failed=1
              fi
              echo "::endgroup::"
            fi
          done <<< "${{ steps.find-templates.outputs.templates }}"

          if [ $failed -eq 1 ]; then
            echo "::error::One or more templates failed validation"
            exit 1
          fi

      - name: Check required files
        run: |
          failed=0
          for template_dir in templates/*/; do
            template_name=$(basename "$template_dir")
            echo "::group::Checking $template_name"

            # Check for required files
            if [ ! -f "${template_dir}warpgate.yaml" ]; then
              echo "::error::Missing warpgate.yaml in $template_name"
              failed=1
            fi

            if [ ! -f "${template_dir}README.md" ]; then
              echo "::warning::Missing README.md in $template_name"
            fi

            echo "::endgroup::"
          done

          if [ $failed -eq 1 ]; then
            exit 1
          fi

      - name: Validate YAML syntax
        run: |
          pip install yamllint
          find templates -name '*.yaml' -o -name '*.yml' | while read -r file; do
            echo "Checking YAML syntax: $file"
            yamllint -d "{extends: relaxed, rules: {line-length: {max: 120}}}" "$file"
          done

  metadata-check:
    name: Check Template Metadata
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Check metadata completeness
        run: |
          python << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          required_fields = ['name', 'version', 'description', 'author', 'license']
          failed = False

          for template_file in Path('templates').rglob('warpgate.yaml'):
              print(f"\nChecking metadata in: {template_file}")

              with open(template_file) as f:
                  data = yaml.safe_load(f)

              metadata = data.get('metadata', {})

              for field in required_fields:
                  if field not in metadata or not metadata[field]:
                      print(f"  ✗ Missing required field: {field}")
                      failed = True
                  else:
                      print(f"  ✓ {field}: {metadata[field]}")

              # Check warpgate version requirement
              requires = metadata.get('requires', {})
              if 'warpgate' not in requires:
                  print("  ⚠ Warning: No warpgate version requirement specified")

          if failed:
              print("\n::error::One or more templates have incomplete metadata")
              sys.exit(1)
          else:
              print("\n✓ All templates have complete metadata")
          EOF

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, metadata-check]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ] || [ "${{ needs.metadata-check.result }}" != "success" ]; then
            echo "::error::Template validation failed"
            exit 1
          fi
          echo "✓ All validations passed"
